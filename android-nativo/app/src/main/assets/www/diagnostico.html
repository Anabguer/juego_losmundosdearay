<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Los Mundos de Aray</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .test-section { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-result { margin: 5px 0; padding: 5px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        #log { background: #000; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace; height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîß Diagn√≥stico - Los Mundos de Aray</h1>
    
    <div class="test-section">
        <h2>1. Verificaci√≥n de GameBridge</h2>
        <div id="gamebridge-test"></div>
        <button class="btn-primary" onclick="testGameBridge()">Probar GameBridge</button>
    </div>
    
    <div class="test-section">
        <h2>2. Verificaci√≥n de Firebase</h2>
        <div id="firebase-test"></div>
        <button class="btn-primary" onclick="testFirebase()">Probar Firebase</button>
    </div>
    
    <div class="test-section">
        <h2>3. Verificaci√≥n de Caramelos</h2>
        <div id="candies-test"></div>
        <button class="btn-success" onclick="testCandies()">Probar Caramelos</button>
        <button class="btn-danger" onclick="resetCandies()">Reset Caramelos</button>
    </div>
    
    <div class="test-section">
        <h2>4. Verificaci√≥n de Progreso</h2>
        <div id="progress-test"></div>
        <button class="btn-primary" onclick="testProgress()">Probar Progreso</button>
    </div>
    
    <div class="test-section">
        <h2>5. Verificaci√≥n de Minijuegos</h2>
        <div id="games-test"></div>
        <button class="btn-primary" onclick="testAllGames()">Probar Todos los Juegos</button>
    </div>
    
    <div class="test-section">
        <h2>6. Test de Firestore</h2>
        <div id="firestore-test"></div>
        <button class="btn-primary" onclick="testFirestore()">Probar Firestore</button>
    </div>
    
    <div class="test-section">
        <h2>7. Log de Diagn√≥stico</h2>
        <div id="log"></div>
        <button class="btn-danger" onclick="clearLog()">Limpiar Log</button>
    </div>

    <script>
        let logDiv = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `test-result ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        function testGameBridge() {
            log('üß™ Iniciando test de GameBridge...', 'info');
            const resultDiv = document.getElementById('gamebridge-test');
            resultDiv.innerHTML = '';
            
            if (window.GameBridge) {
                log('‚úÖ GameBridge est√° disponible', 'success');
                addResult(resultDiv, 'GameBridge disponible', 'success');
                
                // Test m√©todos b√°sicos
                const methods = ['getUser', 'addCandies', 'updateBestLevel', 'getBestLevel', 'getCandiesAsync'];
                methods.forEach(method => {
                    if (window.GameBridge[method]) {
                        log(`‚úÖ M√©todo ${method} disponible`, 'success');
                        addResult(resultDiv, `M√©todo ${method} disponible`, 'success');
                    } else {
                        log(`‚ùå M√©todo ${method} NO disponible`, 'error');
                        addResult(resultDiv, `M√©todo ${method} NO disponible`, 'error');
                    }
                });
                
                // Test getUser
                try {
                    const userData = window.GameBridge.getUser();
                    log(`üìä getUser() resultado: ${userData}`, 'info');
                    addResult(resultDiv, `getUser(): ${userData}`, 'info');
                } catch (e) {
                    log(`‚ùå Error en getUser(): ${e.message}`, 'error');
                    addResult(resultDiv, `Error en getUser(): ${e.message}`, 'error');
                }
                
            } else {
                log('‚ùå GameBridge NO est√° disponible', 'error');
                addResult(resultDiv, 'GameBridge NO disponible', 'error');
            }
        }
        
        function testFirebase() {
            log('üî• Iniciando test de Firebase...', 'info');
            const resultDiv = document.getElementById('firebase-test');
            resultDiv.innerHTML = '';
            
            // Verificar si estamos en Android
            if (window.GameBridge) {
                log('‚úÖ Estamos en Android con GameBridge', 'success');
                addResult(resultDiv, 'Android con GameBridge', 'success');
                
                // Test login
                try {
                    const userData = window.GameBridge.getUser();
                    if (userData && userData !== '{}') {
                        log('‚úÖ Usuario logueado en Firebase', 'success');
                        addResult(resultDiv, 'Usuario logueado', 'success');
                    } else {
                        log('‚ö†Ô∏è Usuario NO logueado', 'warning');
                        addResult(resultDiv, 'Usuario NO logueado', 'warning');
                    }
                } catch (e) {
                    log(`‚ùå Error verificando login: ${e.message}`, 'error');
                    addResult(resultDiv, `Error login: ${e.message}`, 'error');
                }
            } else {
                log('‚ùå No estamos en Android', 'error');
                addResult(resultDiv, 'No Android', 'error');
            }
        }
        
        function testCandies() {
            log('üç¨ Iniciando test de caramelos...', 'info');
            const resultDiv = document.getElementById('candies-test');
            resultDiv.innerHTML = '';
            
            if (window.GameBridge && window.GameBridge.getCandiesAsync) {
                log('‚úÖ getCandiesAsync disponible', 'success');
                addResult(resultDiv, 'getCandiesAsync disponible', 'success');
                
                // Configurar callback
                window.onCandies = (n) => {
                    log(`üç¨ Caramelos recibidos: ${n}`, 'success');
                    addResult(resultDiv, `Caramelos: ${n}`, 'success');
                };
                
                // Solicitar caramelos
                window.GameBridge.getCandiesAsync();
                log('üì° Caramelos solicitados...', 'info');
                
                // Test a√±adir caramelos
                setTimeout(() => {
                    if (window.GameBridge.addCandies) {
                        log('‚ûï A√±adiendo 1 caramelo...', 'info');
                        window.GameBridge.addCandies(1);
                        addResult(resultDiv, 'Caramelo a√±adido', 'info');
                    }
                }, 1000);
                
            } else {
                log('‚ùå getCandiesAsync NO disponible', 'error');
                addResult(resultDiv, 'getCandiesAsync NO disponible', 'error');
            }
        }
        
        function testProgress() {
            log('üìä Iniciando test de progreso...', 'info');
            const resultDiv = document.getElementById('progress-test');
            resultDiv.innerHTML = '';
            
            if (window.GameBridge && window.GameBridge.updateBestLevel) {
                log('‚úÖ updateBestLevel disponible', 'success');
                addResult(resultDiv, 'updateBestLevel disponible', 'success');
                
                // Test actualizar progreso
                const testGameId = 'test';
                const testLevel = 5;
                
                log(`üìà Actualizando progreso: ${testGameId} nivel ${testLevel}`, 'info');
                window.GameBridge.updateBestLevel(testGameId, testLevel);
                addResult(resultDiv, `Progreso actualizado: ${testGameId} nivel ${testLevel}`, 'info');
                
                // Test obtener progreso
                setTimeout(() => {
                    if (window.GameBridge.getBestLevel) {
                        log(`üì• Obteniendo progreso: ${testGameId}`, 'info');
                        window.GameBridge.getBestLevel(testGameId);
                        addResult(resultDiv, `Progreso solicitado: ${testGameId}`, 'info');
                    }
                }, 1000);
                
            } else {
                log('‚ùå updateBestLevel NO disponible', 'error');
                addResult(resultDiv, 'updateBestLevel NO disponible', 'error');
            }
        }
        
        function testAllGames() {
            log('üéÆ Iniciando test de todos los juegos...', 'info');
            const resultDiv = document.getElementById('games-test');
            resultDiv.innerHTML = '';
            
            const games = [
                { id: 'skate', name: 'Skate' },
                { id: 'cole', name: 'Cole' },
                { id: 'informatica', name: 'Inform√°tica' },
                { id: 'chuches', name: 'Chuches' },
                { id: 'parque', name: 'Parque' },
                { id: 'yayos', name: 'Yayos' },
                { id: 'edificio', name: 'Edificio' },
                { id: 'pabellon', name: 'Pabell√≥n' },
                { id: 'rio', name: 'R√≠o' }
            ];
            
            games.forEach((game, index) => {
                setTimeout(() => {
                    log(`üéØ Probando ${game.name} (${game.id})`, 'info');
                    
                    if (window.GameBridge && window.GameBridge.updateBestLevel) {
                        window.GameBridge.updateBestLevel(game.id, index + 1);
                        addResult(resultDiv, `${game.name}: nivel ${index + 1}`, 'success');
                    } else {
                        addResult(resultDiv, `${game.name}: GameBridge no disponible`, 'error');
                    }
                }, index * 500);
            });
        }
        
        function resetCandies() {
            log('üîÑ Reseteando caramelos...', 'warning');
            if (window.GameBridge && window.GameBridge.addCandies) {
                // Esto es solo para test - en producci√≥n no deber√≠a permitir valores negativos
                log('‚ö†Ô∏è No se puede resetear desde aqu√≠ por seguridad', 'warning');
            }
        }
        
        function testFirestore() {
            log('üî• Iniciando test de Firestore...', 'info');
            const resultDiv = document.getElementById('firestore-test');
            resultDiv.innerHTML = '';
            
            if (window.GameBridge && window.GameBridge.runDiagnosticTests) {
                log('‚úÖ runDiagnosticTests disponible', 'success');
                addResult(resultDiv, 'runDiagnosticTests disponible', 'success');
                
                try {
                    window.GameBridge.runDiagnosticTests();
                    log('üß™ Tests de Firestore ejecutados', 'info');
                    addResult(resultDiv, 'Tests ejecutados - revisar Logcat', 'info');
                } catch (e) {
                    log(`‚ùå Error ejecutando tests: ${e.message}`, 'error');
                    addResult(resultDiv, `Error: ${e.message}`, 'error');
                }
            } else {
                log('‚ùå runDiagnosticTests NO disponible', 'error');
                addResult(resultDiv, 'runDiagnosticTests NO disponible', 'error');
            }
        }
        
        function addResult(container, message, type) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }
        
        // Auto-test al cargar
        window.addEventListener('load', () => {
            log('üöÄ Diagn√≥stico iniciado', 'info');
            setTimeout(() => {
                testGameBridge();
            }, 1000);
        });
    </script>
</body>
</html>
